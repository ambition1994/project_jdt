function updatePagerIcons(a){var b={"ui-icon-seek-first":"ace-icon fa fa-angle-double-left bigger-140","ui-icon-seek-prev":"ace-icon fa fa-angle-left bigger-140","ui-icon-seek-next":"ace-icon fa fa-angle-right bigger-140","ui-icon-seek-end":"ace-icon fa fa-angle-double-right bigger-140"};$(".ui-pg-table:not(.navtable) > tbody > tr > .ui-pg-button > .ui-icon").each(function(){var a=$(this),c=$.trim(a.attr("class").replace("ui-icon",""));c in b&&a.attr("class","ui-icon "+b[c])})}function enableTooltips(a){$(".navtable .ui-pg-button").tooltip({container:"body"}),$(a).find(".ui-pg-div").tooltip({container:"body"})}function bxgrid_englishCheck(a,b){var c=/^\w+$/;return!c.test(a)&&isAvailable(a)?[!1,"列【"+b+"】的值【"+a+"】格式出错：格式应该由数字、英文字母或者下划线组成的字符串",""]:[!0,""]}function bxgrid_stringCheck(a,b){var c=/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/;return!c.test(a)&&isAvailable(a)?[!1,"列【"+b+"】的值【"+a+"】格式出错：格式应该为由汉字、数字、英文字母、下划线组成",""]:[!0,""]}function bxgrid_stringWithSpacesCheck(a,b){var c=/^[ a-zA-Z0-9_\u4e00-\u9fa5]+$/;return!c.test(a)&&isAvailable(a)?[!1,"列【"+b+"】的值【"+a+"】格式出错：格式应该为由汉字、数字、英文字母、下划线、空格组成",""]:[!0,""]}function bxgrid_maxLengthCheck(a,b,c){return a.length>c?[!1,"列【"+b+"】的值【"+a+"】长度不能超过："+c,""]:[!0,""]}function bxgrid_phoneCheck(a,b){var c=/^[0-9\\-]*$/;return!c.test(a)&&isAvailable(a)?[!1,"列【"+b+"】的值【"+a+"】格式出错：格式应该为数字、横线组成",""]:[!0,""]}function bxgrid_stringExcludeSpecialCharacters(a,b){var c=/[#&\$\^\*\+\\\|\[\]\?]/;return c.test(a)&&isAvailable(a)?[!1,"列【"+b+"】的值【"+a+"】格式出错：不能包含的字符有 #$^*+\\|[]?&",""]:[!0,""]}!function(a){"function"==typeof define&&define.amd?define("bxgrid",["jqgrid","jqgridlocale","bxalert","bxdialog"],function(){a(window.jQuery)}):a(window.jQuery)}(function(a){$.widget("baosight.bxgrid",{_create:function(){var a="table_"+this.element.attr("id");if(0==$("#"+a).length&&$('<table id="'+a+'" style="width: 100%"> </tableid> ').appendTo($(this.element)),1==this.options.option.supportPage){var b="page_"+a;0==$("#"+b).length&&$(this.element).after($('<div id="'+b+'"></div> '))}this._divElement=this.element,this.rootElement=$("#"+this.element.attr("id")),this.element=$("#"+a),this._super(),console.log("bxgrid widget create")},_divElement:{},_init:function(){this._super(),console.log("bxgrid widget init");var a=this;$.extend(a.options.option,a.options.gridOption);for(var b=a.options.option.colModel,c=0;c<b.length;c++)"rb"!=b[c].name&&"cn"!=b[c].name&&(1==b[c].editable?a.options.columnEditMap[b[c].name]=!0:a.options.columnEditMap[b[c].name]=!1,1!=b[c].sortable&&(b[c].sortable=!1));1==a.options.option.supportPage?(a.options.option.rowNum=a._getCustSettingByDefault(a.options.option.rowNum,10),a.options.option.rowList=a._getCustSettingByDefault(a.options.option.rowList,[10,50,100]),a.options.option.page=a._getCustSettingByDefault(a.options.option.page,1),a.options.option.onPaging=function(b){"url"==a.options.dataPattern&&a._queryPage(b)},a.options.option.pager=$("#page_"+a.element.attr("id")),isAvailable(a.options.option.recordtext)||(a.options.option.recordtext="第 {0}-{1}行，总共{2}行记录"),isAvailable(a.options.option.pgtext)||(a.options.option.pgtext="当前页码：{0}  共{1}页")):a.options.option.rowNum=9999,1==a.options.option.sortable&&(a.options.queryParam.fieldName=a.options.option.sortname,a.options.queryParam.ascDesc=a.options.option.sortorder),(null==a.options.option.onSortCol||void 0==a.options.option.onSortCol)&&(a.options.option.onSortCol=function(b,c,d){a.options.queryParam.fieldName=b,a.options.queryParam.ascDesc=d,a.options.option.sortname=b,a.query()}),a._handlerCustomOption(),$("#"+a.element.attr("id")).jqGrid(a.options.option),$("#"+a.element.attr("id")).closest(".ui-jqgrid").css({"border-left":"1px solid #E1E1E1","border-right":"1px solid #E1E1E1"}),$("#"+a.element.attr("id")).closest(".ui-jqgrid-btable").css({border:"none"}),$("#"+a.element.attr("id")).closest(".ui-jqgrid-bdiv").css({"overflow-x":"hidden"}),0==this.rootElement.find(".ui-jqgrid-labels th:last-child > span").length&&this.rootElement.find(".ui-jqgrid-labels th:last-child > div").before("<span class='ui-jqgrid-resize ui-jqgrid-resize-ltr' style='cursor: col-resize;'>&nbsp;</span>");var d=a.options.navGridOption;1==a.options.option.supportPage&&void 0!=d&&null!=d&&($("#"+a.element.attr("id")).jqGrid("navGrid","#page_"+a.element.attr("id"),d),this._initNavCustBtn()),0==a.options.initQuery?$("#"+a.element.attr("id")).jqGrid("clearGridData"):this.query()},_initNavCustBtn:function(){var a=this,b=this.options.navGridOption;if(1==b.download&&$("#"+this.element.attr("id")).navButtonAdd("#page_"+this.element.attr("id"),{caption:void 0==b.downloadcaption?"":b.downloadcaption,title:void 0==b.downloadtitle?"数据导出":b.downloadtitle,buttonicon:void 0==b.downloadicon?"ace-icon fa fa-cloud-download":b.downloadicon,onClickButton:void 0==b.downloadfunc?function(){a._download()}:b.downloadfunc,position:"last"}),1==b.upload){var c=a.options.navGridOption.uploadParam,d={};d.uploadUrl=c.uploadUrl;for(var e="",f=a.options.option.colModel,g=0;g<f.length;g++){var h=f[g];1!=h.forbidCopy&&1!=h.hidden&&1!=h.forbidExport&&(e+=h.name,g<f.length-1&&(e+=","))}e.lastIndexOf(",")==e.length-1&&(e=e.substring(0,e.length-1)),d.uploadColumn=e;var i="bxgridFileInput";$("#"+this.element.attr("id")).navButtonAdd("#page_"+this.element.attr("id"),{caption:void 0==b.uploadcaption?"":b.uploadcaption,title:void 0==b.uploadtitle?"数据上传":b.uploadtitle,buttonicon:void 0==b.uploadicon?"ace-icon fa fa-cloud-upload":b.uploadicon,onClickButton:void 0==b.uploadfunc?function(){a._upload(i,d,c.uploadFixValueFunc)}:b.uploadfunc,position:"last"})}},_download:function(){for(var a=this,b="",c="",d=this.options.option.colModel,e=this.options.option.colNames,f=0;f<d.length;f++)if("rb"!=d[f].name&&"cn"!=d[f].name){if(1==d[f].hidden||1==d[f].forbidExport)continue;c+=d[f].name,b+=e[f],f<d.length-1&&(c+=",",b+=",")}var g=a._prepare_queryParam();g.curPage=parseInt($(this.element).getGridParam("page")),g.curRowNum=parseInt($(this.element).getGridParam("rowNum")),g.downloadColumnDesc=b,g.downloadColumn=c,g.columnSelectMap=a.options.columnSelectMap,g.columnImageMap=a.options.columnImageMap;var h=httpServerPath+a.options.navGridOption.downloadParam.downloadUrl;h+="?ajaxParam="+JSON.stringify(g),window.location.href=encodeURI(encodeURI(h))},_upload:function(a,b,c){var d=this,e=toolkitPath+"/uploadExcel.do?method=upload";if(e+="&columnSelectMap="+JSON.stringify(d.options.columnSelectMap),e+="&columnImageMap="+JSON.stringify(d.options.columnImageMap),e+="&uploadColumn="+b.uploadColumn,isAvailable(c)){if(b.uploadFixValue=c.call(this),void 0==b.uploadFixValue)return;e+="&uploadFixValue="+b.uploadFixValue}else e+="&uploadFixValue=null";var f=[{html:"<i class='ace-icon fa fa-check bigger-110'></i>&nbsp; 上传","class":"btn btn-skinColor btn-xs",click:function(){var c=(new Date).getTime();$.ajaxFileUpload({url:e,secureuri:!1,fileElementId:a,dataType:"json",success:function(a,e){if(0!=a.status)return void alertDiv("提示",a.returnMsg);var f={onSuccess:function(a){var b=(new Date).getTime();console.log("本次上传耗时："+(b-c)+"毫秒");var e={showMsgId:"alertdiv",status:a.status,showMsg:a.returnMsg};d.options.showMsgOpt=e,d.query(),isAvailable(d.options.navGridOption.uploadParam.uploadCallBackFunc)&&d.options.navGridOption.uploadParam.uploadCallBackFunc(a)}};AjaxCommunicator.ajaxRequest(b.uploadUrl,"POST",a,f)},error:function(a,b,c){console.log("上传失败，状态："+b+"，错误信息："+c)}}),$(this).dialog("close")}}];uploadDiv({fileId:a,title:"上传文件",buttons:f})},_handlerCustomOption:function(){for(var a=this,b=a.options.option.colModel,c=0;c<b.length;c++){var d=b[c];if("ccs"==d.edittype){d.edittype="select",d.formatter="select";var e={onSuccess:function(a){var b={},c={};if("0"==a.errCode&&isAvailable(a.ccs.children))for(var e=0;e<a.ccs.children.length;e++){var f=a.ccs.children[e];c[f.value]=f.label}b.value=c,d.editoptions=b}},f={};if(f.ccsId=d.editoptions,!isAvailable(f.ccsId))continue;AjaxCommunicator.ajaxRequest("/ccshandler.do?method=query","POST",f,e,!1)}"select"==d.edittype&&(a.options.columnSelectMap[d.name]=d.editoptions.value),"link"==d.formatter&&d.image&&(a.options.columnImageMap[d.name]=!0)}},destroy:function(){console.log("bxgrid widget destroy"),this._superApply(arguments)},options:{url:"",queryParam:{},extendParam:{},showMsgOpt:{},columnEditMap:{},columnSelectMap:{},columnImageMap:{},initQuery:!0,async:!0,dataPattern:"local",refreshInCurrentPage:!0,option:{primaryRowKey:"",datatype:"local",height:326,autowidth:!0,forceFit:!0,viewrecords:!0,altRows:!0,multiselect:!0,caption:"bxui表格组件",loading:!0,supportPage:!0,loadComplete:function(){var a=$(this.element);setTimeout(function(){updatePagerIcons(a),enableTooltips(a)},0)},onSelectRow:function(a){},onCellSelect:function(a,b,c,d){var e=$(this).find("#"+a+" input[type=checkbox]"),f=$(this).jqGrid("getGridParam","primaryRowKey"),g=$(this).jqGrid("getRowData",a);if(isAvailable(e)&&e.length>0)if($(d.target).is("input[type=checkbox]"))if(0==$(e[0]).prop("checked"))$(this).jqGrid("saveRow",a,null,"clientArray");else{if($(this).editRow(a,!0),!isAvailable(g[f])||g[f].indexOf('class="editable"')>0)return;null==$(this).jqGrid("getGridParam","insertOrUpdate")?$(this).jqGrid("setGridParam",{insertOrUpdate:"update"}):"insert"==$(this).jqGrid("getGridParam","insertOrUpdate")&&isAvailable(g[f])&&(alertDiv("提示","新增记录时,请先保存,再做其他操作!"),$(this).setSelection(a,!0),$(this).jqGrid("saveRow",a,null,"clientArray"))}else $(d.target).is("input[type=button]")||$(d.target).parent().is("a")||$(d.target).is("a")?$(this).jqGrid("setSelection",a,!1):($(e[0]).prop("checked")&&($(this).editRow(a,!0),$(e[0]).prop("checked",!0)),$(this).jqGrid("setSelection",a,!1))}},navGridOption:{edit:!1,add:!1,del:!1,search:!1,refresh:!1}},_setOption:function(a,b){console.log("_setOption: key=%s  value=%s",a,b),this._superApply(arguments)},_setOptions:function(a){var b;for(b in a)this._setOption(b,a[b]);return this},_getCustSettingByDefault:function(a,b){return void 0!=a&&null!=a?a:b},_prepare_queryParam:function(a){var b=this,c=b.options.curPage,d=b.options.curRowNum;1==b.options.option.sortable&&(b.options.queryParam.fieldName=b.options.option.sortname,(void 0===b.options.queryParam.ascDesc||""===b.options.queryParam.ascDesc)&&(b.options.queryParam.ascDesc=b.options.option.sortorder),isAvailable(b.options.queryParam.fieldName)&&(b.options.queryParam.orderby=b.options.queryParam.fieldName,isAvailable(b.options.queryParam.ascDesc)&&(b.options.queryParam.ascend=b.options.queryParam.ascDesc)));var e=b.options.queryParam;return 0==b.options.option.supportPage?(e.curPage=null,e.curRowNum=null):(e.curPage=c,e.curRowNum=d),$.extend(e,b.options.extendParam),e},query:function(){$("#cb_"+this.element.attr("id")).prop("checked")&&$("#cb_"+this.element.attr("id")).prop("checked",!1);for(var a=this.options.option.colModel,b=0;b<a.length;b++)"rb"!=a[b].name&&"cn"!=a[b].name&&(a[b].editable=this.options.columnEditMap[a[b].name],this.element.jqGrid("setColProp",a[b].name,{editable:this.options.columnEditMap[a[b].name]}));if("local"==this.options.dataPattern){var c=this;void 0!=c.options.option.data&&null!=c.options.option.data&&$(window).bind("resize",function(){var a=c.element.attr("id").split("_")[1];$("#"+c.element.attr("id")).setGridWidth($("#"+a).width())}),this.queryFromLocal()}else"url"==this.options.dataPattern&&this.queryFromService()},queryFromLocal:function(){$("#"+this.element.attr("id")).jqGrid(this.options.option),$("#"+this.element.attr("id")).jqGrid("setGridParam",{insertOrUpdate:"null"})},queryFromService:function(){var a=this,b=1,c=a.options.curRowNum;1==a.options.refreshInCurrentPage&&(b=$("#"+a.element.attr("id")).jqGrid("getGridParam","page")),(null==c||void 0==c)&&(c=$("#"+a.element.attr("id")).jqGrid("getGridParam","rowNum")),a.options.curPage=b,a.options.curRowNum=c,$("#"+this.element.attr("id")).jqGrid("clearGridData"),a._ajaxRequest(a._prepare_queryParam())},refresh:function(){console.log("bxgrid refresh"),$("#cb_"+this.element.attr("id")).prop("checked")&&$("#cb_"+this.element.attr("id")).prop("checked",!1);var a=this,b=a.options.curPage,c=a.options.curRowNum;(null==b||void 0==b)&&(b=$(this.element).getGridParam("page"),a.options.curPage=b),(null==c||void 0==c)&&(c=$(this.element).getGridParam("rowNum"),a.options.curRowNum=c),a._ajaxRequest(a._prepare_queryParam())},refreshLocalData:function(a){var b=this.element.attr("id");$("#"+b).jqGrid("clearGridData").jqGrid("setGridParam",{datatype:"local",data:a}).trigger("reloadGrid")},refreshGridOption:function(a){var b=this.element.attr("id");$.extend(this.options.option,a),$("#"+b).jqGrid(this.options.option)},refreshOptions:function(a){this.element.attr("id");$.extend(this.options,a)},_queryPage:function(a){console.log("bxgrid说queryPage");var b=this;$("#"+this.element.attr("id")).jqGrid(b.options.option);var c=b.options.curPage;if(a=="first_page_"+b.element.attr("id"))c=1;else if(a=="prev_page_"+b.element.attr("id"))c-=1;else if(a=="next_page_"+b.element.attr("id"))c+=1;else if(a=="last_page_"+b.element.attr("id"))c=$("#"+b.element.attr("id")).jqGrid("getGridParam","lastpage");else if("user"==a){var d=$("#page_"+b.element.attr("id")+" .ui-pg-input").val();c=!isNaN(d)&&isAvailable(d)&&isAvailable(d.trim())?parseInt(d):1}else b.options.curRowNum=parseInt($("#page_"+b.element.attr("id")+" .ui-pg-selbox:first").val()),c>1&&(c=1);b.options.curPage=c,b._ajaxRequest(b._prepare_queryParam())},_ajaxRequest:function(a){var b=this,c=$(this._divElement),d={onSuccess:function(a){if("url"==b.options.dataPattern){b.options.option.loading&&c.unblock(),b._loadGrid(a),$("#"+b.element.attr("id")).find(".ui-priority-secondary").css({background:b.options.gridOption.rowColor});var d=b.options.showMsgOpt.showMsgId,e=b.options.showMsgOpt.status,f=b.options.showMsgOpt.showMsg;if(void 0!=d&&null!=d)if(void 0!=e&&null!=e&&void 0!=f&&null!=f){var g={status:e,showMsg:f};void 0!=$("#"+d)&&($("#"+d).bxalert(g),$("#"+d).bxalert("show")),b.options.showMsgOpt.status=void 0,b.options.showMsgOpt.showMsg=void 0}else if(void 0!=a.status&&null!=a.status&&void 0!=a.returnMsg&&null!=a.returnMsg){var g={status:a.status,showMsg:a.returnMsg.replace(/<br>/g,"，")};void 0!=$("#"+d)&&($("#"+d).bxalert(g),$("#"+d).bxalert("show"))}}$(window).bind("resize",function(){var a=b.element.attr("id").split("_")[1];$("#"+b.element.attr("id")).setGridWidth($("#"+a).width())}),null!=b.options.callBackFunct&&void 0!=b.options.callBackFunct&&b.options.callBackFunct(a),$("#"+b.element.attr("id")).jqGrid("setGridParam",{insertOrUpdate:"null"})},onError:function(a,d,e){b.options.option.loading&&c.unblock()}};"url"==b.options.dataPattern&&b.options.option.loading&&c.block({message:"请求处理中，请等待...",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),AjaxCommunicator.ajaxRequest(b.options.url,"POST",a,d,b.options.async)},_loadGrid:function(a){$("#"+this.element.attr("id")).jqGrid("clearGridData"),$("#"+this.element.attr("id"))[0].addJSONData(a)},selectRow:function(a){var b=$(this).find("#"+a+" input[type=checkbox]");1==b.prop("checked")||$("#"+this.element.attr("id")).jqGrid("setSelection",a,!1)},rawMethodCallMore:function(){return $("#"+this.element.attr("id")).jqGrid.apply(this.element,arguments)},rawMethodCall:function(a,b){return $("#"+this.element.attr("id")).jqGrid(a,b)},setInfoFromGrid:function(a,b){var c=$(this.element).getGridParam("selarrrow"),d=a[b];isAvailable(d)||(d=new Object,a[b]=d);for(var e=new Array,f=0;f<c.length;f++){$("#"+this.element.attr("id")).jqGrid("saveRow",c[f],null,"clientArray");var g=$("#"+this.element.attr("id")).jqGrid("getRowData",c[f]);e.push(g)}d.resultRow=e},getCheckRow:function(){for(var a=[],b=$(this).jqGrid("getDataIDs"),c=0;c<b.length;c++){var d=widgetGrid.find("#"+b[c]+" input[type=checkbox]");1==d.prop("checked")&&a.push(b[c])}return a},whetherValidRow:function(a){var b=$("#"+this.element.attr("id")).jqGrid("getGridParam","primaryRowKey");if(!isAvailable(a))return!1;var c=$(this.element).jqGrid("getRowData",a);return!isAvailable(c[b])||c[b].indexOf(a+"_"+b)>-1?!1:!0},getResotreRowDataById:function(a){return this.whetherValidRow(a)?($(this.element).jqGrid("restoreRow",a),$(this.element).jqGrid("getRowData",a)):void 0},addAndCopy:function(){var a=$("#"+this.element.attr("id"));a.jqGrid("setGridParam",{insertOrUpdate:"insert"});for(var b={},c=a.jqGrid("getGridParam","colModel"),d=a.jqGrid("getGridParam","primaryRowKey"),e=0;e<c.length;e++)if("rb"!=c[e].name&&"cn"!=c[e].name){if(1==c[e].forbidCopy?b[c[e].name]=!1:b[c[e].name]=!0,1==c[e].readOnly)continue;c[e].editable=!0}var f=deepCopy(a.jqGrid("getGridParam","selarrrow")),g=a.jqGrid("getDataIDs"),h=0;if(g.length>0){var i=g[0],j=g[g.length-1];h=parseFloat(i)>parseFloat(j)?parseFloat(i):parseFloat(j)}if(f.length>0){var k=[{html:"<i class='ace-icon fa fa-check bigger-110'></i>&nbsp; 是","class":"btn btn-skinColor btn-xs",click:function(){for(var c=0,e=0;e<f.length;e++){h+=1;var g=h;a.jqGrid("saveRow",f[e]);var i=a.jqGrid("getRowData",f[e]),j=!0;if(isAvailable(i[d])&&i[d].indexOf(f[e]+"_"+d)<0&&(j=!1),1!=j){var k=a.find("#"+f[e]+" input[type=checkbox]");k.prop("checked",!1),a.jqGrid("restoreRow",f[e]),a.jqGrid("setSelection",f[e],!1),i=a.jqGrid("getRowData",f[e]);var l=deepCopyWithKeyMap(i,b);a.addRowData(g+"",l,"first"),a.jqGrid("editRow",g+"",!0),a.jqGrid("setSelection",g+"",!1);var m=a.find("#"+g+" input[type=checkbox]");m.prop("checked",!0)}else{if(c++,f.length==c){alertDiv("提示","勾选的记录未提交，状态无效，请基于有效记录进行复制操作！");break}h-=1}}$(this).dialog("close")}},{html:"<i class='ace-icon fa fa-times bigger-110'></i>&nbsp; 否","class":"btn btn-xs",click:function(){$(this).dialog("close")}}];confirmDiv("提示","【"+f.length+"】条记录被选中，将它们复制为新记录吗？",k)}else{var l=h+1+"";a.addRowData(l,{},"first"),a.jqGrid("editRow",l,!0);var m=$(this).find("#"+l+" input[type=checkbox]");m.prop("checked",!0),a.jqGrid("setSelection",l,!1)}}})});