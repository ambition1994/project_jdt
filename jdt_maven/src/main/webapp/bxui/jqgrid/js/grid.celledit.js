!function(a){"use strict";a.jgrid.extend({editCell:function(b,c,d){return this.each(function(){var e,f,g,h,i=this;if(i.grid&&i.p.cellEdit===!0){if(c=parseInt(c,10),i.p.selrow=i.rows[b].id,i.p.knv||a(i).jqGrid("GridNav"),i.p.savedRow.length>0){if(d===!0&&b==i.p.iRow&&c==i.p.iCol)return;a(i).jqGrid("saveCell",i.p.savedRow[0].id,i.p.savedRow[0].ic)}else window.setTimeout(function(){a("#"+a.jgrid.jqID(i.p.knv)).attr("tabindex","-1").focus()},0);if(h=i.p.colModel[c],e=h.name,"subgrid"!==e&&"cb"!==e&&"rn"!==e){if(g=a("td:eq("+c+")",i.rows[b]),h.editable!==!0||d!==!0||g.hasClass("not-editable-cell"))parseInt(i.p.iCol,10)>=0&&parseInt(i.p.iRow,10)>=0&&(a("td:eq("+i.p.iCol+")",i.rows[i.p.iRow]).removeClass("edit-cell ui-state-highlight"),a(i.rows[i.p.iRow]).removeClass("selected-row ui-state-hover")),g.addClass("edit-cell ui-state-highlight"),a(i.rows[b]).addClass("selected-row ui-state-hover"),f=g.html().replace(/\&#160\;/gi,""),a(i).triggerHandler("jqGridSelectCell",[i.rows[b].id,e,f,b,c]),a.isFunction(i.p.onSelectCell)&&i.p.onSelectCell.call(i,i.rows[b].id,e,f,b,c);else{parseInt(i.p.iCol,10)>=0&&parseInt(i.p.iRow,10)>=0&&(a("td:eq("+i.p.iCol+")",i.rows[i.p.iRow]).removeClass("edit-cell ui-state-highlight"),a(i.rows[i.p.iRow]).removeClass("selected-row ui-state-hover")),a(g).addClass("edit-cell ui-state-highlight"),a(i.rows[b]).addClass("selected-row ui-state-hover");try{f=a.unformat.call(i,g,{rowId:i.rows[b].id,colModel:h},c)}catch(j){f=h.edittype&&"textarea"===h.edittype?a(g).text():a(g).html()}if(i.p.autoencode&&(f=a.jgrid.htmlDecode(f)),h.edittype||(h.edittype="text"),i.p.savedRow.push({id:b,ic:c,name:e,v:f}),("&nbsp;"===f||"&#160;"===f||1===f.length&&160===f.charCodeAt(0))&&(f=""),a.isFunction(i.p.formatCell)){var k=i.p.formatCell.call(i,i.rows[b].id,e,f,b,c);void 0!==k&&(f=k)}a(i).triggerHandler("jqGridBeforeEditCell",[i.rows[b].id,e,f,b,c]),a.isFunction(i.p.beforeEditCell)&&i.p.beforeEditCell.call(i,i.rows[b].id,e,f,b,c);var l=a.extend({},h.editoptions||{},{id:b+"_"+e,name:e}),m=a.jgrid.createEl.call(i,h.edittype,l,f,!0,a.extend({},a.jgrid.ajaxOptions,i.p.ajaxSelectOptions||{}));a(g).html("").append(m).attr("tabindex","0"),a.jgrid.bindEv.call(i,m,l),window.setTimeout(function(){a(m).focus()},0),a("input, select, textarea",g).bind("keydown",function(d){if(27===d.keyCode&&(a("input.hasDatepicker",g).length>0?a(".ui-datepicker").is(":hidden")?a(i).jqGrid("restoreCell",b,c):a("input.hasDatepicker",g).datepicker("hide"):a(i).jqGrid("restoreCell",b,c)),13===d.keyCode)return a(i).jqGrid("saveCell",b,c),!1;if(9===d.keyCode){if(i.grid.hDiv.loading)return!1;d.shiftKey?a(i).jqGrid("prevCell",b,c):a(i).jqGrid("nextCell",b,c)}d.stopPropagation()}),a(i).triggerHandler("jqGridAfterEditCell",[i.rows[b].id,e,f,b,c]),a.isFunction(i.p.afterEditCell)&&i.p.afterEditCell.call(i,i.rows[b].id,e,f,b,c)}i.p.iCol=c,i.p.iRow=b}}})},saveCell:function(b,c){return this.each(function(){var d,e=this;if(e.grid&&e.p.cellEdit===!0){if(d=e.p.savedRow.length>=1?0:null,null!==d){var f,g,h=a("td:eq("+c+")",e.rows[b]),i=e.p.colModel[c],j=i.name,k=a.jgrid.jqID(j);switch(i.edittype){case"select":if(i.editoptions.multiple){var l=a("#"+b+"_"+k,e.rows[b]),m=[];f=a(l).val(),f?f.join(","):f="",a("option:selected",l).each(function(b,c){m[b]=a(c).text()}),g=m.join(",")}else f=a("#"+b+"_"+k+" option:selected",e.rows[b]).val(),g=a("#"+b+"_"+k+" option:selected",e.rows[b]).text();i.formatter&&(g=f);break;case"checkbox":var n=["Yes","No"];i.editoptions&&(n=i.editoptions.value.split(":")),f=a("#"+b+"_"+k,e.rows[b]).is(":checked")?n[0]:n[1],g=f;break;case"password":case"text":case"textarea":case"button":f=a("#"+b+"_"+k,e.rows[b]).val(),g=f;break;case"custom":try{if(!i.editoptions||!a.isFunction(i.editoptions.custom_value))throw"e1";if(f=i.editoptions.custom_value.call(e,a(".customelement",h),"get"),void 0===f)throw"e2";g=f}catch(o){"e1"===o&&a.jgrid.info_dialog(a.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,a.jgrid.edit.bClose),"e2"===o?a.jgrid.info_dialog(a.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,a.jgrid.edit.bClose):a.jgrid.info_dialog(a.jgrid.errors.errcap,o.message,a.jgrid.edit.bClose)}}if(g!==e.p.savedRow[d].v){var p=a(e).triggerHandler("jqGridBeforeSaveCell",[e.rows[b].id,j,f,b,c]);if(p&&(f=p,g=p),a.isFunction(e.p.beforeSaveCell)){var q=e.p.beforeSaveCell.call(e,e.rows[b].id,j,f,b,c);q&&(f=q,g=q)}var r=a.jgrid.checkValues.call(e,f,c);if(r[0]===!0){var s=a(e).triggerHandler("jqGridBeforeSubmitCell",[e.rows[b].id,j,f,b,c])||{};if(a.isFunction(e.p.beforeSubmitCell)&&(s=e.p.beforeSubmitCell.call(e,e.rows[b].id,j,f,b,c),s||(s={})),a("input.hasDatepicker",h).length>0&&a("input.hasDatepicker",h).datepicker("hide"),"remote"===e.p.cellsubmit)if(e.p.cellurl){var t={};e.p.autoencode&&(f=a.jgrid.htmlEncode(f)),t[j]=f;var u,v,w;w=e.p.prmNames,u=w.id,v=w.oper,t[u]=a.jgrid.stripPref(e.p.idPrefix,e.rows[b].id),t[v]=w.editoper,t=a.extend(s,t),a("#lui_"+a.jgrid.jqID(e.p.id)).show(),e.grid.hDiv.loading=!0,a.ajax(a.extend({url:e.p.cellurl,data:a.isFunction(e.p.serializeCellData)?e.p.serializeCellData.call(e,t):t,type:"POST",complete:function(d,i){if(a("#lui_"+e.p.id).hide(),e.grid.hDiv.loading=!1,"success"===i){var k=a(e).triggerHandler("jqGridAfterSubmitCell",[e,d,t.id,j,f,b,c])||[!0,""];k[0]===!0&&a.isFunction(e.p.afterSubmitCell)&&(k=e.p.afterSubmitCell.call(e,d,t.id,j,f,b,c)),k[0]===!0?(a(h).empty(),a(e).jqGrid("setCell",e.rows[b].id,c,g,!1,!1,!0),a(h).addClass("dirty-cell"),a(e.rows[b]).addClass("edited"),a(e).triggerHandler("jqGridAfterSaveCell",[e.rows[b].id,j,f,b,c]),a.isFunction(e.p.afterSaveCell)&&e.p.afterSaveCell.call(e,e.rows[b].id,j,f,b,c),e.p.savedRow.splice(0,1)):(a.jgrid.info_dialog(a.jgrid.errors.errcap,k[1],a.jgrid.edit.bClose),a(e).jqGrid("restoreCell",b,c))}},error:function(d,f,g){a("#lui_"+a.jgrid.jqID(e.p.id)).hide(),e.grid.hDiv.loading=!1,a(e).triggerHandler("jqGridErrorCell",[d,f,g]),a.isFunction(e.p.errorCell)?(e.p.errorCell.call(e,d,f,g),a(e).jqGrid("restoreCell",b,c)):(a.jgrid.info_dialog(a.jgrid.errors.errcap,d.status+" : "+d.statusText+"<br/>"+f,a.jgrid.edit.bClose),a(e).jqGrid("restoreCell",b,c))}},a.jgrid.ajaxOptions,e.p.ajaxCellOptions||{}))}else try{a.jgrid.info_dialog(a.jgrid.errors.errcap,a.jgrid.errors.nourl,a.jgrid.edit.bClose),a(e).jqGrid("restoreCell",b,c)}catch(o){}"clientArray"===e.p.cellsubmit&&(a(h).empty(),a(e).jqGrid("setCell",e.rows[b].id,c,g,!1,!1,!0),a(h).addClass("dirty-cell"),a(e.rows[b]).addClass("edited"),a(e).triggerHandler("jqGridAfterSaveCell",[e.rows[b].id,j,f,b,c]),a.isFunction(e.p.afterSaveCell)&&e.p.afterSaveCell.call(e,e.rows[b].id,j,f,b,c),e.p.savedRow.splice(0,1))}else try{window.setTimeout(function(){a.jgrid.info_dialog(a.jgrid.errors.errcap,f+" "+r[1],a.jgrid.edit.bClose)},100),a(e).jqGrid("restoreCell",b,c)}catch(o){}}else a(e).jqGrid("restoreCell",b,c)}window.setTimeout(function(){a("#"+a.jgrid.jqID(e.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(b,c){return this.each(function(){var d,e=this;if(e.grid&&e.p.cellEdit===!0){if(d=e.p.savedRow.length>=1?0:null,null!==d){var f=a("td:eq("+c+")",e.rows[b]);if(a.isFunction(a.fn.datepicker))try{a("input.hasDatepicker",f).datepicker("hide")}catch(g){}a(f).empty().attr("tabindex","-1"),a(e).jqGrid("setCell",e.rows[b].id,c,e.p.savedRow[d].v,!1,!1,!0),a(e).triggerHandler("jqGridAfterRestoreCell",[e.rows[b].id,e.p.savedRow[d].v,b,c]),a.isFunction(e.p.afterRestoreCell)&&e.p.afterRestoreCell.call(e,e.rows[b].id,e.p.savedRow[d].v,b,c),e.p.savedRow.splice(0,1)}window.setTimeout(function(){a("#"+e.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(b,c){return this.each(function(){var d,e=this,f=!1;if(e.grid&&e.p.cellEdit===!0){for(d=c+1;d<e.p.colModel.length;d++)if(e.p.colModel[d].editable===!0){f=d;break}f!==!1?a(e).jqGrid("editCell",b,f,!0):e.p.savedRow.length>0&&a(e).jqGrid("saveCell",b,c)}})},prevCell:function(b,c){return this.each(function(){var d,e=this,f=!1;if(e.grid&&e.p.cellEdit===!0){for(d=c-1;d>=0;d--)if(e.p.colModel[d].editable===!0){f=d;break}f!==!1?a(e).jqGrid("editCell",b,f,!0):e.p.savedRow.length>0&&a(e).jqGrid("saveCell",b,c)}})},GridNav:function(){return this.each(function(){function b(b,c,e){if("v"===e.substr(0,1)){var f=a(d.grid.bDiv)[0].clientHeight,g=a(d.grid.bDiv)[0].scrollTop,h=d.rows[b].offsetTop+d.rows[b].clientHeight,i=d.rows[b].offsetTop;"vd"===e&&h>=f&&(a(d.grid.bDiv)[0].scrollTop=a(d.grid.bDiv)[0].scrollTop+d.rows[b].clientHeight),"vu"===e&&g>i&&(a(d.grid.bDiv)[0].scrollTop=a(d.grid.bDiv)[0].scrollTop-d.rows[b].clientHeight)}if("h"===e){var j=a(d.grid.bDiv)[0].clientWidth,k=a(d.grid.bDiv)[0].scrollLeft,l=d.rows[b].cells[c].offsetLeft+d.rows[b].cells[c].clientWidth,m=d.rows[b].cells[c].offsetLeft;l>=j+parseInt(k,10)?a(d.grid.bDiv)[0].scrollLeft=a(d.grid.bDiv)[0].scrollLeft+d.rows[b].cells[c].clientWidth:k>m&&(a(d.grid.bDiv)[0].scrollLeft=a(d.grid.bDiv)[0].scrollLeft-d.rows[b].cells[c].clientWidth)}}function c(a,b){var c,e;if("lft"===b)for(c=a+1,e=a;e>=0;e--)if(d.p.colModel[e].hidden!==!0){c=e;break}if("rgt"===b)for(c=a-1,e=a;e<d.p.colModel.length;e++)if(d.p.colModel[e].hidden!==!0){c=e;break}return c}var d=this;if(d.grid&&d.p.cellEdit===!0){d.p.knv=d.p.id+"_kn";var e,f,g=a("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+d.p.knv+"'></div></div>");a(g).insertBefore(d.grid.cDiv),a("#"+d.p.knv).focus().keydown(function(g){switch(f=g.keyCode,"rtl"===d.p.direction&&(37===f?f=39:39===f&&(f=37)),f){case 38:d.p.iRow-1>0&&(b(d.p.iRow-1,d.p.iCol,"vu"),a(d).jqGrid("editCell",d.p.iRow-1,d.p.iCol,!1));break;case 40:d.p.iRow+1<=d.rows.length-1&&(b(d.p.iRow+1,d.p.iCol,"vd"),a(d).jqGrid("editCell",d.p.iRow+1,d.p.iCol,!1));break;case 37:d.p.iCol-1>=0&&(e=c(d.p.iCol-1,"lft"),b(d.p.iRow,e,"h"),a(d).jqGrid("editCell",d.p.iRow,e,!1));break;case 39:d.p.iCol+1<=d.p.colModel.length-1&&(e=c(d.p.iCol+1,"rgt"),b(d.p.iRow,e,"h"),a(d).jqGrid("editCell",d.p.iRow,e,!1));break;case 13:parseInt(d.p.iCol,10)>=0&&parseInt(d.p.iRow,10)>=0&&a(d).jqGrid("editCell",d.p.iRow,d.p.iCol,!0);break;default:return!0}return!1})}})},getChangedCells:function(b){var c=[];return b||(b="all"),this.each(function(){var d,e=this;e.grid&&e.p.cellEdit===!0&&a(e.rows).each(function(f){var g={};a(this).hasClass("edited")&&(a("td",this).each(function(c){if(d=e.p.colModel[c].name,"cb"!==d&&"subgrid"!==d)if("dirty"===b){if(a(this).hasClass("dirty-cell"))try{g[d]=a.unformat.call(e,this,{rowId:e.rows[f].id,colModel:e.p.colModel[c]},c)}catch(h){g[d]=a.jgrid.htmlDecode(a(this).html())}}else try{g[d]=a.unformat.call(e,this,{rowId:e.rows[f].id,colModel:e.p.colModel[c]},c)}catch(h){g[d]=a.jgrid.htmlDecode(a(this).html())}}),g.id=this.id,c.push(g))})}),c}})}(jQuery);